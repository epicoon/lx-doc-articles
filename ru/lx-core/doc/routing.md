[Английская версия (English version)](https://github.com/epicoon/lx-doc-articles/blob/master/en/lx-core/doc/routing.md)

## Роутинг

* [Роутинг приложения](#app)
* [Роутинг сервиса](#service)


<a name="app"><h3>Роутинг приложения</h3></a>
Приложение распределяет запросы по сервисам с помощью роутера. Он существует в приложении в единственном числе. Настраивается роутер приложения при помощи параметра конфигурации `router`. Данному параметру в конфигурации приложения сопоставляется ассоциативный масив, содержащий информацию о роутере приложения. Обязательно должен содержать элемент с ключом `type`, с одним из двух значений:
* `map` - в этом случае требуется поясняющий параметр `routes` - карта роутинга. Карта представляет собой ассоциативный массив, где ключ - путь URL запроса (или регулярное выражение), значение - данные об объекте, куда перенаправляется запрос.
* `class` - в этом случае требуется поясняющий параметр `name` - имя класса, отнаследованного от `lx\Router`.
Выглядит в файле конфигурации это примерно следующим образом:
```yaml
router:
  type: map
  routes:
    some-route: route-target-data
```

Роутер приложения перенаправляет запрос на какой-либо сервис. Вариантов перенаправления несколько:
* Сопоставление роута и отвечающего сервиса. Роут передается сервису, сервис перенаправляет запрос при помощи своего роутера на один из своих контроллеров, экшенов или плагинов:
  ```yaml
  routes:
    some-route: someService
  ```
* Аналог предыдущего, но с использованием ключа:
  ```yaml
  routes:
    some-route: {service: someService}
  ```
* Аналог предыдущего, но указывается зависимость от режима работы приложения - роут будет активен только для указанного (указанных) режима:
  ```yaml
  routes:
    some-route: {service: someService, on-mode: [dev]}
  ```
* Сопоставление роута внутреннему роуту отвечающего сервиса (его переопределение)
  Имеем в конфигурации приложения:
  ```yaml
  routes:
    some-route: {service-route: someService:route-in-service}
  ```
  Тогда роут `some-route` будет переадресован на сервис `someService` в виде `route-in-service`, конфигурация сервиса должна определить куда этот роут направить далее:
  ```yaml
  routes:
    route-in-service: ...
  ```
* Перенаправление роута напрямую на контроллер сервиса:
  ```yaml
  routes:
    # В данном случае будет выполнен метод контроллера [[run()]]
    some-route-1: {service-controller: someService:ControllerName}

    # В данном случае будет выполнен метод контроллера [[actionName()]]
    some-route-2: {service-controller: someService:ControllerName::actionName}
  ```
* Перенаправление роута напрямую на экшен сервиса:
  ```yaml
  routes:
    # Будет выполнен метод экшена [[run()]]
    some-route: {service-action: someService:ActionName}
  ```
* Перенаправление роута напрямую на плагин сервиса:
  ```yaml
  routes:
    # В данном случае будет возвращен результат рендеринга плагина
    some-route: {service-plugin: someService:pluginName}
  ```

При этом есть несколько вариантов задания путей URL (ключа карты роутинга, `some-route` в примере выше):
* Жесткое сопоставление роута и отвечающего сервиса, пример:<br>
  Имеем в конфигурации приложения:
  ```yaml
  routes:
    some-route: someService
  ```
  Тогда роут `some-route` будет переадресован на сервис `someService` в неизменном виде, конфигурация сервиса должна определить куда этот роут направить далее:
  ```yaml
  routes:
    some-route: ...
  ```
* Сопоставление по регулярному выражению - ключ дожен начинаться с символа `~`, пример:<br>
  Имеем в конфигурации приложения:
  ```yaml
  routes:
    ~^admin\d: adminService
  ```
  Все URL, у которых путь начинается на 'admin' будут перенаправлены на сервис `adminService` в неизменном виде, конфигурация сервиса должна определить куда эти роуты направить далее:
  ```yaml
  routes:
    admin/some-route-1: ...
    admin/some-route-2: ...
  ```
* Предоставление сервису выделенного пути - ключ дожен начинаться с символа `!`, пример:<br>
  Имеем в конфигурации приложения:
  ```yaml
  routes:
    !admin: adminService
  ```
  Имеем в конфигурации сервиса `adminService`:
  ```yaml
  routes:
    some-route-1: ...
    some-route-2: ...
  ```
  Тогда роут `admin/some-route-1` будет переадресован на сервис `adminService` в виде пути `some-route-1`, а запрос `admin/some-route-2` будет переадресован на сервис `adminService` в виде пути `some-route-2`.

![Схема роутинга приложения](https://github.com/epicoon/lx-doc-articles/blob/master/ru/lx-core/images/architecture-scheme.png)


<a name="service"><h3>Роутинг сервиса</h3></a>
Сервис может обработать запрос при помощи одного из своих контроллеров (класс lx\ServiceController, или отнаследованный от него), экшенов (класс lx\ServiceAction, или отнаследованный от него), либо напрямую сопоставить запросу рендеринг одного из своих плагинов. Данное распределение запросов осуществляется с помощью роутера сервиса. Настраивается роутер сервиса при помощи параметра конфигурации `router`. Данному параметру в конфигурации сервиса сопоставляется ассоциативный масив, содержащий информацию о роутере сервиса.
Обязательно должен содержать элемент с ключом `type`, с одним из двух значений:
* `map` - в этом случае требуется поясняющий параметр `routes` - карта роутинга. Карта представляет из себя ассоциативный массив, где ключ - путь URL запроса (или регулярное выражение), значение - данные об объекте, куда перенаправляется запрос.
* `class` - в этом случае требуется поясняющий параметр `name` - имя класса, отнаследованного от `lx\ServiceRouter`.<br>
Пример:
```yaml
router:
  type: map
  routes:
    # Направление запроса на контроллер
    # Будет возвращен результат вызова метода контроллера [[run()]]
    some-route-1: ControllerClassName

    # Направление запроса на контроллер
    # Будет возвращен результат вызова метода(экшена) контроллера [[actionName()]]
    some-route-2: ControllerClassName::actionName

    # Направление запроса на экшен. Будет возвращен результат вызова метода экшена [[run()]]
    some-route-3: {action: ActionClassName}

    # Направление запроса на плагин. Будет возвращен результат рендеринга плагина
    some-route-4: {plugin: pluginName}
```

![Схема внутрисервисного роутинга](https://github.com/epicoon/lx-doc-articles/blob/master/ru/lx-core/images/service-routing.png)
